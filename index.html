<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿çå°è‚‰ - ç·šä¸Šé»é¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-color: #d81b60; --bg-color: #fff0f5; --card-shadow: 0 8px 20px rgba(216, 27, 96, 0.1); }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); padding-bottom: 100px; color: #444; }
        .header-section { position: relative; margin-bottom: -40px; z-index: 1; }
        .header-img { width: 100%; height: 200px; object-fit: cover; border-radius: 0 0 25px 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .main-container { max-width: 600px; margin: 0 auto; position: relative; z-index: 2; padding: 0 15px; }
        .content-card { background: white; border-radius: 20px; padding: 25px; box-shadow: var(--card-shadow); margin-bottom: 20px; }
        h3 { color: var(--primary-color); font-weight: 700; text-align: center; margin-bottom: 5px; }
        .sub-title { text-align: center; color: #888; font-size: 0.9rem; margin-bottom: 20px; }
        .form-label { font-weight: 700; color: #555; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .form-control, .form-select { border-radius: 12px; border: 1px solid #eee; background-color: #f9f9f9; padding: 12px; transition: all 0.3s; }
        .form-control:focus, .form-select:focus { background-color: #fff; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(216, 27, 96, 0.1); }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
        .menu-item:last-child { border-bottom: none; }
        .item-name { font-size: 1.1rem; font-weight: bold; color: #333; }
        .item-desc { font-size: 0.8rem; color: #999; }
        .stepper { display: flex; align-items: center; background: #f0f0f0; border-radius: 20px; padding: 2px; }
        .stepper-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: white; color: var(--primary-color); font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .stepper-btn:active { transform: scale(0.9); }
        .stepper-input { width: 40px; text-align: center; border: none; background: transparent; font-weight: bold; color: #333; pointer-events: none; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; }
        .summary-box { margin-bottom: 10px; font-size: 0.9rem; color: var(--primary-color); font-weight: bold; background: #fff0f5; padding: 8px; border-radius: 8px; text-align: center; }
        .btn-submit { background: linear-gradient(45deg, #d81b60, #ff4081); border: none; border-radius: 12px; padding: 12px; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(216, 27, 96, 0.4); transition: all 0.3s; }
        .btn-submit:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(216, 27, 96, 0.5); }
        .btn-submit:disabled { background: #ccc; box-shadow: none; }
        .required::after { content: "*"; color: red; margin-left: 3px; }
    </style>
</head>
<body>

<div class="header-section text-center">
    <img src="https://placehold.co/800x400/d81b60/ffffff?text=Ah+Jen+Pork" class="header-img" alt="Header">
</div>

<div class="main-container">
    
    <div class="content-card" style="margin-top: 50px;">
        <h3>é˜¿çå°è‚‰</h3>
        <p class="sub-title">æ¯æ—¥ç¾åšï¼Œå¤æ—©å‘³å‚³æ‰¿</p>
        
        <form id="orderForm">
            <div class="mb-3">
                <label class="form-label required"><i class="fas fa-calendar-alt"></i> é å®šå–è²¨æ—¥æœŸ</label>
                <select class="form-select" id="pickupDate">
                    <option value="" disabled selected>è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</option>
                </select>
                <div id="dateLoadingText" class="form-text text-danger" style="display:none;">ç„¡æ³•è¼‰å…¥æ—¥æœŸï¼Œè«‹é‡æ–°æ•´ç†</div>
            </div>

            <div class="mb-3">
                <label class="form-label required"><i class="fas fa-user"></i> å–è²¨äººå§“å</label>
                <input type="text" class="form-control" id="userNameInput" placeholder="ä¾‹å¦‚ï¼šé™³å°å§">
            </div>

            <div class="mb-1">
                <label class="form-label required"><i class="fas fa-phone-alt"></i> è¯çµ¡é›»è©±</label>
                <input type="tel" class="form-control" id="userPhone" placeholder="09xx-xxx-xxx">
            </div>
        </form>
    </div>

    <div class="content-card">
        <h5 class="mb-4" style="font-weight: bold; color: #333; border-left: 4px solid #d81b60; padding-left: 10px;">ç¾å‘³èœå–®</h5>
        
        <div class="menu-item">
            <div><div class="item-name">ğŸ– å°è‚‰</div><div class="item-desc">è‚¥è€Œä¸è†©ï¼Œå…¥å£å³åŒ–</div></div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_pork', -1)"><i class="fas fa-minus"></i></button>
                <input type="text" class="stepper-input" id="qty_pork" value="0" readonly>
                <button type="button" class="stepper-btn" onclick="changeQty('qty_pork', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="menu-item">
            <div><div class="item-name">ğŸ· ç¶œåˆè±¬è…³</div><div class="item-desc">Qå½ˆæœ‰å‹ï¼Œå¯Œå«è† è³ª</div></div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_feet', -1)"><i class="fas fa-minus"></i></button>
                <input type="text" class="stepper-input" id="qty_feet" value="0" readonly>
                <button type="button" class="stepper-btn" onclick="changeQty('qty_feet', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="menu-item">
            <div><div class="item-name">ğŸ— è¹„æ—</div><div class="item-desc">çš®è–„è‚‰å«©ï¼Œä¸‹é£¯é¦–é¸</div></div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_thigh', -1)"><i class="fas fa-minus"></i></button>
                <input type="text" class="stepper-input" id="qty_thigh" value="0" readonly>
                <button type="button" class="stepper-btn" onclick="changeQty('qty_thigh', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="menu-item">
            <div><div class="item-name">ğŸ‹ ç­å­</div><div class="item-desc">é®®ç”œå…¥å‘³</div></div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_bamboo', -1)"><i class="fas fa-minus"></i></button>
                <input type="text" class="stepper-input" id="qty_bamboo" value="0" readonly>
                <button type="button" class="stepper-btn" onclick="changeQty('qty_bamboo', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="mt-4">
            <label class="form-label"><i class="fas fa-edit"></i> å‚™è¨»éœ€æ±‚</label>
            <textarea class="form-control" id="note" rows="2" placeholder="ä¾‹å¦‚ï¼šç˜¦è‚‰å¤šã€è¹„æ—å¤§ä¸€é»..."></textarea>
        </div>
    </div>
</div>

<div class="bottom-bar">
    <div id="summaryDisplay" class="summary-box" style="display: none;"></div>
    <button type="button" class="btn btn-primary w-100 btn-submit" onclick="submitOrder()">
        ç¢ºèªé€å‡ºè¨‚å–® <i class="fas fa-paper-plane ms-2"></i>
    </button>
</div>

<input type="hidden" id="userId">

<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
    // â˜…â˜…â˜… æ‚¨çš„å°ˆå±¬è¨­å®š â˜…â˜…â˜…
    const API_URL = "https://script.google.com/macros/s/AKfycby6mG2x-sYYeHJZ5AQhDMEOgpC0QqElTWx6XPKy2gDFiPWSLwfQoalaTe-DRCZna6w_/exec";  
    const LIFF_ID = "2008905608-DekFDzvW"; 

    window.onload = function() {
        // 1. åˆå§‹åŒ– LIFF
        liff.init({ liffId: LIFF_ID }).then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    document.getElementById('userId').value = profile.userId;
                    document.getElementById('userNameInput').value = profile.displayName;
                });
            } else {
                liff.login();
            }
        });

        // 2. è‡ªå‹•å¾ Google Sheet æŠ“å–æ—¥æœŸ
        fetchDates();
    };

    function fetchDates() {
        const dateSelect = document.getElementById('pickupDate');
        
        fetch(API_URL) 
        .then(response => response.json())
        .then(dates => {
            dateSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å–è²¨æ—¥æœŸ</option>';
            
            if (dates.length === 0) {
                 dateSelect.innerHTML = '<option value="" disabled>ç›®å‰ç„¡é–‹æ”¾æ—¥æœŸ</option>';
                 return;
            }

            dates.forEach(date => {
                let option = document.createElement("option");
                option.text = date;
                option.value = date;
                dateSelect.add(option);
            });
        })
        .catch(err => {
            console.error("æ—¥æœŸè¼‰å…¥å¤±æ•—", err);
            dateSelect.innerHTML = '<option value="" disabled>æ—¥æœŸè¼‰å…¥å¤±æ•—</option>';
            document.getElementById('dateLoadingText').style.display = 'block';
        });
    }

    function changeQty(id, delta) {
        const input = document.getElementById(id);
        let currentVal = parseInt(input.value) || 0;
        let newVal = currentVal + delta;
        if (newVal < 0) newVal = 0;
        if (newVal > 20) newVal = 20; 
        input.value = newVal;
        updateSummary();
    }

    function updateSummary() {
        let p1 = parseInt(document.getElementById('qty_pork').value);
        let p2 = parseInt(document.getElementById('qty_feet').value);
        let p3 = parseInt(document.getElementById('qty_thigh').value);
        let p4 = parseInt(document.getElementById('qty_bamboo').value);

        let summary = [];
        if(p1 > 0) summary.push(`å°è‚‰x${p1}`);
        if(p2 > 0) summary.push(`è±¬è…³x${p2}`);
        if(p3 > 0) summary.push(`è¹„æ—x${p3}`);
        if(p4 > 0) summary.push(`ç­å­x${p4}`);

        let displayDiv = document.getElementById('summaryDisplay');
        if (summary.length > 0) {
            displayDiv.style.display = 'block';
            displayDiv.innerHTML = "ğŸ›’ ç›®å‰é¸æ“‡ï¼š " + summary.join('ã€');
        } else {
            displayDiv.style.display = 'none';
        }
    }

    // â˜… æ›´æ–°å¾Œçš„é€å–®ç¨‹å¼ï¼ŒåŒ…å«ç™¼é€ LINE è¨Šæ¯ â˜…
    function submitOrder() {
        let qty_pork = document.getElementById('qty_pork').value;
        let qty_feet = document.getElementById('qty_feet').value;
        let qty_thigh = document.getElementById('qty_thigh').value;
        let qty_bamboo = document.getElementById('qty_bamboo').value;
        
        let manualName = document.getElementById('userNameInput').value;
        let userPhone = document.getElementById('userPhone').value;
        let noteInput = document.getElementById('note').value;
        let pickupDate = document.getElementById('pickupDate').value;

        // é©—è­‰
        if (!pickupDate) { alert("è«‹é¸æ“‡é å®šå–è²¨æ—¥æœŸå–”ï¼ğŸ“…"); document.getElementById('pickupDate').focus(); return; }
        if (!manualName) { alert("è«‹å¡«å¯«å–è²¨äººå§“åï¼ğŸ‘¤"); document.getElementById('userNameInput').focus(); return; }
        if (!userPhone) { alert("è«‹å¡«å¯«è¯çµ¡é›»è©±ï¼ğŸ“"); document.getElementById('userPhone').focus(); return; }
        if (qty_pork == 0 && qty_feet == 0 && qty_thigh == 0 && qty_bamboo == 0) { alert("ğŸ˜… è³¼ç‰©è»Šæ˜¯ç©ºçš„å–”ï¼"); return; }

        // æº–å‚™è¦å‚³é€çš„è³‡æ–™
        const orderData = {
            pickupDate: pickupDate,
            userName: manualName,
            userPhone: userPhone,
            qty_pork: qty_pork,
            qty_feet: qty_feet,
            qty_thigh: qty_thigh,
            qty_bamboo: qty_bamboo,
            note: noteInput
        };

        // æº–å‚™ã€Œå­˜æ ¹è¯ã€çš„æ–‡å­—å…§å®¹ (LINE è¨Šæ¯ç”¨)
        let receiptItems = [];
        if(qty_pork > 0) receiptItems.push(`å°è‚‰ x${qty_pork}`);
        if(qty_feet > 0) receiptItems.push(`ç¶œåˆè±¬è…³ x${qty_feet}`);
        if(qty_thigh > 0) receiptItems.push(`è¹„æ— x${qty_thigh}`);
        if(qty_bamboo > 0) receiptItems.push(`ç­å­ x${qty_bamboo}`);
        
        let receiptText = `ã€é˜¿çå°è‚‰ - è¨‚è³¼æˆåŠŸã€‘\n` +
                          `ğŸ“… å–è²¨æ—¥æœŸï¼š${pickupDate}\n` +
                          `ğŸ‘¤ å–è²¨äººï¼š${manualName}\n` +
                          `------------------\n` +
                          `${receiptItems.join('\n')}\n` +
                          `------------------\n` +
                          `ğŸ“ é›»è©±ï¼š${userPhone}\n` +
                          `ğŸ“ å‚™è¨»ï¼š${noteInput || 'ç„¡'}\n\n` +
                          `è€é—†å¨˜å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®ï¼Œç•¶å¤©è¦‹ï¼â¤ï¸`;

        // UI é–å®š
        const btn = document.querySelector('.btn-submit');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';
        btn.disabled = true;

        // 1. å…ˆé€è³‡æ–™çµ¦ Google Sheet (å¾Œå°)
        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            // 2. å¾Œå°æˆåŠŸå¾Œï¼Œç™¼é€ LINE è¨Šæ¯ (å‰å°)
            if (liff.isInClient()) {
                liff.sendMessages([
                    {
                        type: 'text',
                        text: receiptText
                    }
                ])
                .then(() => {
                    alert("âœ… è¨‚è³¼æˆåŠŸï¼LINE èŠå¤©å®¤å·²å‚³é€è¨‚å–®æ˜ç´°ã€‚");
                    liff.closeWindow();
                })
                .catch((err) => {
                    console.log('error', err);
                    alert("âœ… è¨‚è³¼æˆåŠŸï¼(è«‹è¨˜å¾—æˆªåœ–ç•«é¢ï¼Œè¨Šæ¯ç™¼é€æ¬Šé™å¯èƒ½æœªé–‹å•Ÿ)");
                    liff.closeWindow();
                });
            } else {
                alert("âœ… è¨‚è³¼æˆåŠŸï¼");
                window.location.reload(); 
            }
        })
        .catch(error => {
            alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–ç›´æ¥è¯ç¹«è€é—†ã€‚");
            btn.innerHTML = 'ç¢ºèªé€å‡ºè¨‚å–®';
            btn.disabled = false;
        });
    }
</script>

</body>
</html>