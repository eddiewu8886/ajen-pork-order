<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿çå°è‚‰ - ç·šä¸Šé»é¤</title>
    
    <meta property="og:title" content="é˜¿çå°è‚‰ - ç·šä¸Šé»é¤" />
    <meta property="og:description" content="æ¯æ—¥ç¾åšãƒ»å¤æ—©å‘³å‚³æ‰¿ã€‚æ­¡è¿ç·šä¸Šé è¨‚ç¾å‘³å°è‚‰ã€è¹„è†€ï¼" />
    <meta property="og:image" content="https://eddlewu8886.github.io/ajen-pork-order/banner.png" /> 
    <meta property="og:url" content="https://liff.line.me/2008905608-DekFDzvW" />
    <meta property="og:type" content="website" />

    <meta name="description" content="é˜¿çå°è‚‰æä¾›æ¯æ—¥ç¾åšçš„å¤æ—©å‘³å°è‚‰ã€è¹„è†€èˆ‡è±¬è…³ï¼Œæ­¡è¿ä½¿ç”¨ç·šä¸Šç³»çµ±é è¨‚å–è²¨ã€‚" />

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* â˜… é…è‰²ä¿®æ”¹å€ï¼šæŸ”å’Œå¥¶èŒ¶è‰²ç³» */
        :root {
            --primary-color: #9A7E6F;
            --primary-hover: #826a5c;
            --bg-color: #F8F5F2;
            --card-bg: #ffffff;
            --text-dark: #5D4037;
            --text-light: #8D6E63;
            --card-shadow: 0 4px 15px rgba(154, 126, 111, 0.15);
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            padding-bottom: 110px; 
            color: var(--text-dark); 
        }

        .header-section { position: relative; margin-bottom: -40px; z-index: 1; }
        .header-img { 
            width: 100%; height: 220px; object-fit: cover; 
            border-radius: 0 0 30px 30px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            filter: brightness(0.95);
        }

        .main-container { max-width: 600px; margin: 0 auto; position: relative; z-index: 2; padding: 0 15px; }

        .content-card { 
            background: var(--card-bg); border-radius: 20px; padding: 25px; 
            box-shadow: var(--card-shadow); margin-bottom: 20px; 
            border: 1px solid #EFEBE9;
        }

        h3 { color: var(--primary-color); font-weight: 700; text-align: center; margin-bottom: 5px; letter-spacing: 1px; }
        .sub-title { text-align: center; color: var(--text-light); font-size: 0.9rem; margin-bottom: 20px; }

        .form-label { font-weight: 700; color: var(--text-dark); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .form-control, .form-select { border-radius: 12px; border: 1px solid #D7CCC8; background-color: #FAFAFA; padding: 12px; color: var(--text-dark); }
        .form-control:focus, .form-select:focus { background-color: #fff; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(154, 126, 111, 0.1); }

        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px dashed #D7CCC8; transition: all 0.3s; }
        .menu-item:last-child { border-bottom: none; }
        
        /* å”®å®Œæ¨£å¼ */
        .item-sold-out { opacity: 0.6; pointer-events: none; filter: grayscale(100%); }
        .badge-sold-out { background-color: #9e9e9e; color: white; font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        .item-name { font-size: 1.15rem; font-weight: bold; color: var(--text-dark); }
        .item-desc { font-size: 0.85rem; color: #9E9E9E; margin-bottom: 2px;}
        .item-price { 
            font-size: 0.95rem; color: var(--primary-color); font-weight: 600; 
            background: #EFEBE9; padding: 2px 8px; border-radius: 6px; display: inline-block;
        }

        .stepper { display: flex; align-items: center; background: #F5F5F5; border-radius: 25px; padding: 3px; }
        .stepper-btn { 
            width: 32px; height: 32px; border-radius: 50%; border: none; 
            background: white; color: var(--primary-color); font-weight: bold; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; touch-action: manipulation; 
        }
        .stepper-btn:active { transform: scale(0.9); }
        .stepper-btn:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; }
        
        .stepper-input { 
            width: 50px; text-align: center; border: 1px solid transparent; background: transparent; 
            font-weight: bold; color: var(--text-dark); pointer-events: auto; border-radius: 4px;
        }
        .stepper-input:focus { background: #fff; border-color: var(--primary-color); outline: none; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .bottom-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(5px); 
            border-radius: 25px 25px 0 0; padding: 20px; 
            box-shadow: 0 -5px 20px rgba(154, 126, 111, 0.1); z-index: 1000; border-top: 1px solid #EFEBE9;
        }

        .summary-box { margin-bottom: 12px; font-size: 0.95rem; color: var(--primary-color); font-weight: bold; background: #EFEBE9; padding: 10px; border-radius: 10px; text-align: center; }

        .btn-submit { 
            background: var(--primary-color); color: white; border: none; border-radius: 15px; 
            padding: 14px; font-weight: bold; font-size: 1.1rem; 
            box-shadow: 0 4px 12px rgba(154, 126, 111, 0.3); transition: all 0.3s; 
        }
        .btn-submit:hover:not(:disabled) { background-color: var(--primary-hover); transform: translateY(-2px); }
        .btn-submit:disabled { background: #CFD8DC; box-shadow: none; }

        .required::after { content: "*"; color: #D84315; margin-left: 3px; }
        .item-locked { opacity: 0.5; pointer-events: none; }
        .lock-msg { font-size: 0.8rem; color: #D84315; margin-left: 5px; display: none; }
        
        /* --- å…¨é éª¨æ¶å±æ¨£å¼ --- */
        #skeletonOverlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--bg-color); 
            z-index: 9998; 
            overflow-y: scroll; 
            padding-bottom: 100px;
        }

        .sk-shimmer {
            background: #E0E0E0;
            background-image: linear-gradient(to right, #E0E0E0 0%, #F5F5F5 20%, #E0E0E0 40%, #E0E0E0 100%);
            background-repeat: no-repeat;
            background-size: 200% 100%; 
            animation: shimmer 1.5s infinite linear;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .sk-header { width: 100%; height: 220px; border-radius: 0 0 30px 30px; margin-bottom: 20px; }
        .sk-container { max-width: 600px; margin: 0 auto; padding: 0 15px; }
        .sk-card { background: white; border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 1px solid #EFEBE9; }
        .sk-title { width: 40%; height: 30px; margin: 0 auto 10px; }
        .sk-subtitle { width: 60%; height: 15px; margin: 0 auto 20px; }
        .sk-label { width: 30%; height: 20px; margin-bottom: 10px; }
        .sk-input { width: 100%; height: 45px; margin-bottom: 20px; border-radius: 12px; }
        .sk-menu-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sk-menu-text { width: 50%; }
        .sk-menu-line { height: 15px; margin-bottom: 5px; }
        .sk-menu-btn { width: 100px; height: 35px; border-radius: 20px; }    
    </style>
</head>
<body>

<div id="closedOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; text-align: center; padding-top: 150px;">
    <i class="fas fa-store-slash" style="font-size: 5rem; color: #9A7E6F; margin-bottom: 20px;"></i>
    <h2 style="color: #5D4037; font-weight: bold;">æœ¬åº—ä¼‘æ¯ä¸­</h2>
    <p style="color: #8D6E63; font-size: 1.2rem;" id="closedReason">ç›®å‰æš«åœæ¥å–®ï¼Œè«‹ç¨å¾Œå†ä¾†ï¼</p>
</div>

<div id="skeletonOverlay">
    <div class="sk-header sk-shimmer"></div>
    <div class="sk-container">
        <div class="sk-card">
            <div class="sk-title sk-shimmer"></div>
            <div class="sk-subtitle sk-shimmer"></div>
            <div class="sk-label sk-shimmer"></div>
            <div class="sk-input sk-shimmer"></div>
            <div class="sk-label sk-shimmer"></div>
            <div class="sk-input sk-shimmer"></div>
            <div class="sk-label sk-shimmer"></div>
            <div class="sk-input sk-shimmer"></div>
        </div>
        <div class="sk-card">
             <div class="sk-menu-row"><div class="sk-menu-text"><div class="sk-menu-line sk-shimmer" style="width: 60%"></div><div class="sk-menu-line sk-shimmer" style="width: 40%"></div></div><div class="sk-menu-btn sk-shimmer"></div></div>
             <div class="sk-menu-row"><div class="sk-menu-text"><div class="sk-menu-line sk-shimmer" style="width: 60%"></div><div class="sk-menu-line sk-shimmer" style="width: 40%"></div></div><div class="sk-menu-btn sk-shimmer"></div></div>
             <div class="sk-menu-row"><div class="sk-menu-text"><div class="sk-menu-line sk-shimmer" style="width: 60%"></div><div class="sk-menu-line sk-shimmer" style="width: 40%"></div></div><div class="sk-menu-btn sk-shimmer"></div></div>
             <div class="sk-menu-row"><div class="sk-menu-text"><div class="sk-menu-line sk-shimmer" style="width: 60%"></div><div class="sk-menu-line sk-shimmer" style="width: 40%"></div></div><div class="sk-menu-btn sk-shimmer"></div></div>
        </div>
    </div>
</div>

<div class="header-section text-center">
    <img src="banner.png" class="header-img" alt="Header">
</div>

<div class="main-container">
    
    <div class="content-card" style="margin-top: 50px;">
        <h3>é˜¿çå°è‚‰</h3>
        <p class="sub-title">æ¯æ—¥ç¾åšãƒ»å¤æ—©å‘³å‚³æ‰¿</p>
        
        <form id="orderForm">
            <div class="mb-3">
                <label class="form-label required"><i class="fas fa-calendar-alt"></i> é å®šå–è²¨æ—¥æœŸ</label>
                <select class="form-select" id="pickupDate">
                    <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
                </select>
                <div id="dateLoadingText" class="form-text text-danger" style="display:none;">ç„¡æ³•è¼‰å…¥æ—¥æœŸï¼Œè«‹é‡æ–°æ•´ç†</div>
            </div>

            <div class="mb-3">
                <label class="form-label required"><i class="fas fa-user"></i> å–è²¨äººå§“å</label>
                <input type="text" class="form-control" id="userNameInput" placeholder="ä¾‹å¦‚ï¼šé™³å°å§">
            </div>

            <div class="mb-1">
                <label class="form-label required"><i class="fas fa-phone-alt"></i> è¯çµ¡é›»è©±</label>
                <input type="tel" class="form-control" id="userPhone" placeholder="09xx-xxx-xxx">
            </div>
        </form>
    </div>

    <div class="content-card">
        <h5 class="mb-4" style="font-weight: bold; color: var(--text-dark); border-left: 5px solid var(--primary-color); padding-left: 12px;">ç¾å‘³èœå–®</h5>
        
        <div class="menu-item" id="item_qty_pork">
            <div>
                <div class="item-name">ğŸ– å°è‚‰</div>
                <div class="item-desc">è‚¥è€Œä¸è†©ï¼Œå…¥å£å³åŒ–</div>
                <div class="item-price" id="price_qty_pork">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_pork', -1)"><i class="fas fa-minus"></i></button>
                <input type="number" inputmode="numeric" class="stepper-input" id="qty_pork" value="0" oninput="manualChange(this.id)" onblur="checkEmpty(this.id)">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_pork', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="menu-item" id="item_qty_thigh">
            <div>
                <div class="item-name">ğŸ— è¹„è†€</div>
                <div class="item-desc">çš®è–„è‚‰å«©ï¼Œä¸‹é£¯é¦–é¸</div>
                <div class="item-price" id="price_qty_thigh">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_thigh', -1)"><i class="fas fa-minus"></i></button>
                <input type="number" inputmode="numeric" class="stepper-input" id="qty_thigh" value="0" oninput="manualChange(this.id)" onblur="checkEmpty(this.id)">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_thigh', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="menu-item" id="item_qty_feet">
            <div>
                <div class="item-name">ğŸ· ç¶œåˆè±¬è…³</div>
                <div class="item-desc">Qå½ˆæœ‰å‹ï¼Œå¯Œå«è† è³ª</div>
                <div class="item-price" id="price_qty_feet">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_feet', -1)"><i class="fas fa-minus"></i></button>
                <input type="number" inputmode="numeric" class="stepper-input" id="qty_feet" value="0" oninput="manualChange(this.id)" onblur="checkEmpty(this.id)">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_feet', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="menu-item" id="item_qty_bamboo">
            <div>
                <div class="item-name">ğŸ‹ ç­å¹²</div>
                <div class="item-desc">é®®ç”œå…¥å‘³</div>
                <div class="item-price" id="price_qty_bamboo">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="stepper">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_bamboo', -1)"><i class="fas fa-minus"></i></button>
                <input type="number" inputmode="numeric" class="stepper-input" id="qty_bamboo" value="0" oninput="manualChange(this.id)" onblur="checkEmpty(this.id)">
                <button type="button" class="stepper-btn" onclick="changeQty('qty_bamboo', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="menu-item" id="row_extra" style="opacity: 0.6; transition: all 0.3s;">
            <div>
                <div class="item-name">
                    ğŸ¦´ åŠ è³¼è…³è¹„ 
                    <span class="lock-msg" id="lockMsg" style="display:inline-block;">(éœ€è³¼è²·ä¸»é¤)</span>
                </div>
                <div class="item-desc">å–œæ„›å•ƒéª¨é ­çš„å¿…åŠ </div>
                <div class="item-price" id="price_qty_extra">è¼‰å…¥ä¸­...</div>
            </div>
            <div class="stepper">
                <button type="button" class="stepper-btn btn-extra" disabled onclick="changeQty('qty_extra', -1)"><i class="fas fa-minus"></i></button>
                <input type="number" inputmode="numeric" class="stepper-input" id="qty_extra" value="0" oninput="manualChange(this.id)" onblur="checkEmpty(this.id)" disabled>
                <button type="button" class="stepper-btn btn-extra" disabled onclick="changeQty('qty_extra', 1)"><i class="fas fa-plus"></i></button>
            </div>
        </div>

        <div class="mt-4">
            <label class="form-label"><i class="fas fa-edit"></i> å‚™è¨»éœ€æ±‚</label>
            <textarea class="form-control" id="note" rows="2" placeholder="ä¾‹å¦‚ï¼šç˜¦è‚‰å¤šã€è¹„æ—å¤§ä¸€é»..."></textarea>
        </div>
        
        <div class="mt-3 text-center text-muted small">
            <i class="fas fa-info-circle"></i> åƒ¹æ ¼åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é‡‘é¡ä¾ç¾å ´ç§¤é‡ç‚ºä¸»
        </div>
    </div>
</div>

<div class="bottom-bar">
    <div id="summaryDisplay" class="summary-box" style="display: none;"></div>
    <button type="button" class="btn btn-primary w-100 btn-submit" onclick="submitOrder()">
        ç¢ºèªé€å‡ºè¨‚å–® <i class="fas fa-paper-plane ms-2"></i>
    </button>
</div>

<input type="hidden" id="userId">

<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<script>
    // â˜…â˜…â˜… è«‹æ›¿æ›æˆæ‚¨çš„è¨­å®š â˜…â˜…â˜…
    // é€™æ˜¯æ‚¨æä¾›çš„æœ€æ–° API ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbyGG7D2TOUSrPl_3hfGF3DNdGu4po0fQ8qfyXoNV6QBGKxeDVmvWrhKiaAaCULMAs5-/exec";  
    const LIFF_ID = "2008905608-DekFDzvW"; 
    
    let GLOBAL_MENU = {};

    window.onload = function() {

        liff.init({ liffId: LIFF_ID }).then(() => {
            if (liff.isLoggedIn()) {
                liff.getProfile().then(profile => {
                    document.getElementById('userId').value = profile.userId;
                    document.getElementById('userNameInput').value = profile.displayName;
                });
            } else {
                liff.login();
            }
        });

        initSystem();
        checkAddonAvailability();
    };

    function initSystem() {
        const dateSelect = document.getElementById('pickupDate');
        
        // â˜… ç›£è½æ—¥æœŸè®Šæ›´ï¼šç•¶ä½¿ç”¨è€…æ›æ—¥æœŸï¼Œè‡ªå‹•æ›´æ–°åƒ¹æ ¼
        dateSelect.addEventListener('change', function() {
            updateMenuPrices();
        });

        fetch(API_URL) 
        .then(response => response.json())
        .then(data => {
            // --- 1. è™•ç†æ—¥æœŸ ---
            if (data.dates.length === 0) {
                 document.getElementById('closedOverlay').style.display = 'block';
                 document.getElementById('closedReason').innerText = "ç›®å‰ç„¡é–‹æ”¾æ—¥æœŸï¼Œè«‹ç¨å¾Œå†ä¾†ï¼";
                 document.getElementById('skeletonOverlay').style.display = 'none'; 
                 return;
            } else {
                 document.getElementById('closedOverlay').style.display = 'none';
                 dateSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å–è²¨æ—¥æœŸ</option>';
                 
                 data.dates.forEach(item => {
                    let option = document.createElement("option");
                    option.value = item.value; 
                    option.text = item.text;   
                    if (item.disabled) option.disabled = true; 
                    
                    // â˜… å„²å­˜æª”æœŸä»£è™Ÿ (CNY æˆ– normal) åˆ°é¸é …ä¸­
                    if (item.type) {
                        option.dataset.priceType = item.type;
                    } else {
                        option.dataset.priceType = "normal";
                    }

                    dateSelect.add(option);
                });
            }

            // --- 2. è™•ç†èœå–® ---
            if (data.menu) {
                GLOBAL_MENU = data.menu;
                // è³‡æ–™è¼‰å…¥å¾Œï¼Œå…ˆåŸ·è¡Œä¸€æ¬¡åƒ¹æ ¼æ›´æ–° (é¡¯ç¤ºé è¨­æˆ–ç¬¬ä¸€å¤©çš„åƒ¹æ ¼)
                updateMenuPrices();
            }

            setTimeout(() => {
                document.getElementById('skeletonOverlay').style.display = 'none';
            }, 300);
        })
        .catch(err => {
            console.error("è¼‰å…¥å¤±æ•—", err);
            dateSelect.innerHTML = '<option value="" disabled>è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</option>';
            document.getElementById('skeletonOverlay').style.display = 'none';
        });
    }

    // â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šæ ¹æ“šæ—¥æœŸæ›´æ–°åƒ¹æ ¼ + æª¢æŸ¥å”®å®Œç‹€æ…‹
    function updateMenuPrices() {
        const dateSelect = document.getElementById('pickupDate');
        // å–å¾—ç›®å‰é¸ä¸­æ—¥æœŸçš„æª”æœŸé¡å‹
        const selectedOption = dateSelect.options[dateSelect.selectedIndex];
        const currentType = (selectedOption && selectedOption.dataset.priceType) ? selectedOption.dataset.priceType : 'normal';
        
        for (const [key, item] of Object.entries(GLOBAL_MENU)) {
            let priceDiv = document.getElementById('price_' + key);
            let inputDiv = document.getElementById(key); // æ•¸é‡è¼¸å…¥æ¡†

            // 1. å…ˆè™•ç†å”®å®Œç‹€æ…‹ (å„ªå…ˆç´šæœ€é«˜)
            if (item.soldOut) {
                if (priceDiv) {
                    priceDiv.innerHTML = '<span style="color:#d9534f;"><i class="fas fa-times-circle"></i> å·²å”®å®Œ</span>';
                    priceDiv.style.backgroundColor = 'transparent';
                    priceDiv.style.border = '1px solid #d9534f';
                    priceDiv.style.color = 'inherit'; // é‡ç½®é¡è‰²
                }
                
                if (inputDiv) {
                    inputDiv.value = 0;
                    inputDiv.disabled = true;
                    let parent = inputDiv.parentElement;
                    if (parent) {
                        let btns = parent.querySelectorAll('button');
                        btns.forEach(btn => btn.disabled = true);
                    }
                }
                
                let rowItem = document.getElementById('item_' + key); 
                if (!rowItem && inputDiv) rowItem = inputDiv.closest('.menu-item');
                if (rowItem) rowItem.classList.add('item-sold-out');

                continue; // å·²å”®å®Œå°±ä¸ç”¨ç®¡åƒ¹éŒ¢äº†ï¼Œæ›ä¸‹ä¸€å€‹å“é …
            } 
            
            // 2. å¦‚æœæ²’å”®å®Œï¼Œéœ€è§£é™¤é–å®š (ä»¥é˜²è¬ä¸€)
            if (inputDiv) {
                inputDiv.disabled = false;
                let parent = inputDiv.parentElement;
                if (parent) {
                    let btns = parent.querySelectorAll('button');
                    btns.forEach(btn => btn.disabled = false);
                }
            }
            let rowItem = document.getElementById('item_' + key);
            if (!rowItem && inputDiv) rowItem = inputDiv.closest('.menu-item');
            if (rowItem) rowItem.classList.remove('item-sold-out');

            // 3. è™•ç†åƒ¹æ ¼é¡¯ç¤º (ä¸€èˆ¬ vs éå¹´)
            if (priceDiv) {
                // é‡ç½®æ¨£å¼
                priceDiv.style.backgroundColor = '#EFEBE9';
                priceDiv.style.border = 'none';

                let displayMin = item.min;
                let displayMax = item.max;
                let isCNY = false;

                // åˆ¤æ–·ï¼šå¦‚æœæ˜¯ CNY æª”æœŸ ä¸” è©²å“é …æœ‰è¨­å®šéå¹´åƒ¹
                if (currentType === 'CNY' && item.min_cny) {
                    displayMin = item.min_cny;
                    // å¦‚æœæœ€é«˜åƒ¹æ²’å¡«ï¼Œé è¨­è·Ÿæœ€ä½åƒ¹ä¸€æ¨£
                    displayMax = item.max_cny ? item.max_cny : item.min_cny;
                    isCNY = true;
                }

                // æ›´æ–°æ–‡å­—
                if (displayMin == displayMax) {
                    priceDiv.innerText = `$${displayMin} / ä»½`;
                } else {
                    priceDiv.innerText = `$${displayMin} ~ $${displayMax} / ä»½`;
                }

                // è®Šè‰²æç¤º
                if (isCNY) {
                    priceDiv.style.color = "#D84315"; // éå¹´ç´…
                    priceDiv.style.fontWeight = "bold";
                } else {
                    priceDiv.style.color = "var(--primary-color)";
                }
            }
        }
    }

    function checkAddonAvailability() {
        let mainQty = (parseInt(document.getElementById('qty_pork').value) || 0) +
                      (parseInt(document.getElementById('qty_thigh').value) || 0) +
                      (parseInt(document.getElementById('qty_feet').value) || 0);

        const extraRow = document.getElementById('row_extra');
        const extraBtns = document.querySelectorAll('.btn-extra');
        const extraInput = document.getElementById('qty_extra');
        const lockMsg = document.getElementById('lockMsg');

        // æª¢æŸ¥åŠ è³¼å“é …æœ¬èº«æ˜¯å¦å·²å”®å®Œ
        let isExtraSoldOut = extraInput.disabled && GLOBAL_MENU['qty_extra'] && GLOBAL_MENU['qty_extra'].soldOut;

        if (isExtraSoldOut) {
             return; 
        }

        if (mainQty > 0) {
            extraRow.style.opacity = '1';
            lockMsg.style.display = 'none';
            extraBtns.forEach(btn => btn.disabled = false);
            extraInput.disabled = false;
        } else {
            extraRow.style.opacity = '0.6';
            lockMsg.style.display = 'inline-block';
            extraBtns.forEach(btn => btn.disabled = true);
            extraInput.disabled = true;
            extraInput.value = 0; 
        }
        updateSummary(); 
    }

    function changeQty(id, delta) {
        const input = document.getElementById(id);
        if (input.disabled) return; 

        let currentVal = parseInt(input.value) || 0;
        let newVal = currentVal + delta;
        if (newVal < 0) newVal = 0;
        if (newVal > 50) newVal = 50;
        input.value = newVal;
        checkAddonAvailability();
    }

    function manualChange(id) {
        const input = document.getElementById(id);
        let val = parseInt(input.value);
        if (isNaN(val)) return;
        if (val < 0) input.value = 0;
        if (val > 50) input.value = 50;
        checkAddonAvailability();
    }

    function checkEmpty(id) {
        const input = document.getElementById(id);
        if (input.value === "" || isNaN(parseInt(input.value))) {
            input.value = 0;
            checkAddonAvailability();
        }
    }

    function updateSummary() {
        let items = [
            {id: 'qty_pork', name: 'å°è‚‰'},
            {id: 'qty_thigh', name: 'è¹„è†€'},
            {id: 'qty_feet', name: 'è±¬è…³'},
            {id: 'qty_bamboo', name: 'ç­å¹²'},
            {id: 'qty_extra', name: 'åŠ è³¼è…³è¹„'}
        ];

        let summary = [];
        items.forEach(item => {
            let val = parseInt(document.getElementById(item.id).value) || 0;
            if (val > 0) {
                let displayName = (GLOBAL_MENU[item.id]) ? GLOBAL_MENU[item.id].name : item.name;
                summary.push(`${displayName}x${val}`);
            }
        });

        let displayDiv = document.getElementById('summaryDisplay');
        if (summary.length > 0) {
            displayDiv.style.display = 'block';
            displayDiv.innerHTML = "ğŸ›’ ç›®å‰é¸æ“‡ï¼š " + summary.join('ã€');
        } else {
            displayDiv.style.display = 'none';
        }
    }

    function submitOrder() {
        let qty_pork = document.getElementById('qty_pork').value;
        let qty_thigh = document.getElementById('qty_thigh').value;
        let qty_feet = document.getElementById('qty_feet').value;
        let qty_bamboo = document.getElementById('qty_bamboo').value;
        let qty_extra = document.getElementById('qty_extra').value;

        let manualName = document.getElementById('userNameInput').value;
        let userPhone = document.getElementById('userPhone').value;
        let noteInput = document.getElementById('note').value;
        
        let pickupDateSelect = document.getElementById('pickupDate'); 
        let pickupDate = pickupDateSelect.value;
        
        if (!pickupDate) { 
            Swal.fire({ icon: 'warning', title: 'è«‹é¸æ“‡æ—¥æœŸ', text: 'è¨˜å¾—å‘Šè¨´æˆ‘å€‘å“ªå¤©è¦ä¾†æ‹¿å–”ï¼ğŸ“…', confirmButtonColor: '#9A7E6F' });
            setTimeout(() => pickupDateSelect.focus(), 500); 
            return; 
        }

        let selectedOptionText = pickupDateSelect.options[pickupDateSelect.selectedIndex].text;
        if (selectedOptionText.includes("(å·²é¡æ»¿)") || selectedOptionText.includes("(å·²æˆªæ­¢)")) {
            Swal.fire({ icon: 'error', title: 'ç„¡æ³•ä¸‹å–®', text: 'æŠ±æ­‰ï¼è©²æ—¥æœŸå·²é¡æ»¿æˆ–æˆªæ­¢ ğŸ˜­', confirmButtonColor: '#9A7E6F' });
            return; 
        }

        if (!manualName) { 
            Swal.fire({ icon: 'warning', title: 'å¿˜è¨˜å¡«åå­—å›‰', text: 'è«‹å¡«å¯«å–è²¨äººå§“å ğŸ‘¤', confirmButtonColor: '#9A7E6F' });
            setTimeout(() => document.getElementById('userNameInput').focus(), 500);
            return; 
        }
        if (!userPhone) { 
            Swal.fire({ icon: 'warning', title: 'å¿˜è¨˜å¡«é›»è©±å›‰', text: 'è«‹å¡«å¯«è¯çµ¡é›»è©± ğŸ“', confirmButtonColor: '#9A7E6F' });
            setTimeout(() => document.getElementById('userPhone').focus(), 500);
            return; 
        }
        
        if (qty_pork==0 && qty_feet==0 && qty_thigh==0 && qty_bamboo==0 && qty_extra==0) { 
            Swal.fire({ icon: 'question', title: 'è³¼ç‰©è»Šæ˜¯ç©ºçš„', text: 'æ‚¨é‚„æ²’é¸æ“‡ä»»ä½•ç¾å‘³é¤é»å–”ï¼ğŸ˜…', confirmButtonColor: '#9A7E6F' });
            return; 
        }

        const orderData = {
            pickupDate: pickupDate,
            userName: manualName,
            userPhone: userPhone,
            qty_pork: qty_pork,
            qty_thigh: qty_thigh,
            qty_feet: qty_feet,
            qty_bamboo: qty_bamboo,
            qty_extra: qty_extra, 
            note: noteInput
        };

        // â˜… å–å¾—ç›®å‰çš„æª”æœŸé¡å‹ (ç‚ºäº†è¨ˆç®—æ­£ç¢ºé‡‘é¡)
        const selectedOption = pickupDateSelect.options[pickupDateSelect.selectedIndex];
        const currentType = (selectedOption && selectedOption.dataset.priceType) ? selectedOption.dataset.priceType : 'normal';

        let receiptItems = [];
        let itemsToCheck = ['qty_pork', 'qty_thigh', 'qty_feet', 'qty_bamboo', 'qty_extra'];
        
        itemsToCheck.forEach(key => {
            let qty = parseInt(document.getElementById(key).value) || 0;
            if (qty > 0) {
                let itemData = GLOBAL_MENU[key];
                if (itemData) {
                    // â˜… åˆ¤æ–·åƒ¹æ ¼é‚è¼¯ (è·Ÿ updateMenuPrices ä¸€æ¨£)
                    let useMin = itemData.min;
                    let useMax = itemData.max;
                    
                    if (currentType === 'CNY' && itemData.min_cny) {
                        useMin = itemData.min_cny;
                        useMax = itemData.max_cny ? itemData.max_cny : itemData.min_cny;
                    }

                    let priceStr = "";
                    if (useMin == useMax) {
                        priceStr = `$${useMin * qty}`;
                    } else {
                        priceStr = `ç´„$${useMin * qty}~$${useMax * qty}`;
                    }
                    receiptItems.push(`${itemData.name} x${qty} (${priceStr})`);
                } else {
                    receiptItems.push(`å“é …(${key}) x${qty}`);
                }
            }
        });

        let receiptText = `ã€é˜¿çå°è‚‰ - è¨‚è³¼æˆåŠŸã€‘\n` +
                          `ğŸ“… å–è²¨æ—¥æœŸï¼š${pickupDate}\n` +
                          `ğŸ‘¤ å–è²¨äººï¼š${manualName}\n` +
                          `------------------\n` +
                          `${receiptItems.join('\n')}\n` +
                          `------------------\n` +
                          `ğŸ“ é›»è©±ï¼š${userPhone}\n` +
                          `ğŸ“ å‚™è¨»ï¼š${noteInput || 'ç„¡'}\n\n` +
                          `â€» åƒ¹æ ¼åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é‡‘é¡ä¾ç¾å ´ç§¤é‡ç‚ºä¸»ã€‚\n` + 
                          `å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®ï¼Œç•¶å¤©è¦‹ï¼â¤ï¸`;

        const btn = document.querySelector('.btn-submit');
        btn.disabled = true;

        Swal.fire({
            title: 'è¨‚å–®è™•ç†ä¸­...',
            html: 'æ­£åœ¨å°‡è³‡æ–™å‚³é€çµ¦é˜¿çï¼Œè«‹ç¨å€™ â³',
            allowOutsideClick: false, 
            didOpen: () => {
                Swal.showLoading(); 
            }
        });

        fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
            if (liff.isInClient()) {
                liff.sendMessages([{ type: 'text', text: receiptText }])
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'è¨‚è³¼æˆåŠŸï¼',
                        text: 'è¨‚å–®æ˜ç´°å·²å‚³é€è‡³èŠå¤©å®¤ âœ…',
                        confirmButtonText: 'é—œé–‰è¦–çª—',
                        confirmButtonColor: '#9A7E6F'
                    }).then(() => {
                        liff.closeWindow();
                    });
                })
                .catch((err) => {
                    Swal.fire({ 
                        icon: 'success', 
                        title: 'è¨‚è³¼æˆåŠŸï¼', 
                        text: 'ä½†è¨Šæ¯å‚³é€å¤±æ•—ï¼Œè«‹æ‰‹å‹•é—œé–‰è¦–çª—ã€‚',
                        confirmButtonColor: '#9A7E6F' 
                    }).then(() => liff.closeWindow());
                });
            } else {
                Swal.fire({
                    icon: 'success',
                    title: 'è¨‚è³¼æˆåŠŸï¼',
                    text: 'æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®',
                    confirmButtonText: 'å†è¨‚ä¸€ç­†',
                    confirmButtonColor: '#9A7E6F'
                }).then(() => {
                    window.location.reload(); 
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'ç™¼ç”ŸéŒ¯èª¤',
                text: 'é€£ç·šä¼¼ä¹æœ‰é»å•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ âŒ',
                confirmButtonColor: '#d33'
            });
            btn.innerHTML = 'ç¢ºèªé€å‡ºè¨‚å–® <i class="fas fa-paper-plane ms-2"></i>';
            btn.disabled = false;
        });
    }
</script>

</body>
</html>
